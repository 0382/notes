# 【程序的运行（一）】程序运行的方式

本节讲程序是如何运行的，主要讲讲编译型语言和解释型语言的分类和运行过程。

## 编译器(compiler)

c/c++/fortran是典型的编译型语言。所谓编译型语言，就是使用编译器将源代码编译成二进制机器码，然后通过机器码来运行程序。比如一个`hello.c`文件，首先需要将其编译成`hello.exe`文件。这个文件是二进制文件，其中包含了运行程序所需要的的所有底层指令。程序运行时，计算机将`hello.exe`加载到内存中，其中的机器码就是一系列底层指令，可以直接对应到CPU的计算，一系列的机器码即可以控制CPU作出一系列动作。

上述过程，可以分成两个步骤：**编译**和**运行**。编译过程，需要一个编译器，将`hell.c`转化为`hello.exe`。运行时，则完全和`hello.c`源文件或者编译器无关，只与编译后生成的`test.exe`二进制文件有关。

> c/c++/fortran语言编译器最常用的是GNU组织开发的一套编译器`gcc/g++/gfortran`。科学计算中则常用intel的编译器组件，这三种语言都支持，在intel自家cpu上有特别优化，能够获得更快的速度。除此之外，还有微软的visual c++编译器，是visutal studio自带的c++编译器。还有`llvm`项目中的`clang/clang++`编译器，是苹果电脑默认的c/c++编译器，`llvm`项目目前好像正在开发fortran编译器，不知道进度如何。

## 解释器(interpreter)

python是典型的解释型语言。当你写好一个`hello.py`源代码文件时。想要运行它，需要在`cmd`中输入如下指令：`python hello.py`。此时，`python.exe`软件(解释器)，读入`hello.py`的内容，然后将其内容逐行解释为计算机指令发送给CPU运行，由此完成一个python脚本文件的运行。

上述过程，我们可以看到解释型语言和编译型语言的不同。解释型语言不会产生一个新的文件，运行过程中需要依赖于解释器。没有解释器，则源文件是无法运行的。

之前我们讲过的批处理(batch)脚本，以及linux中的shell脚本都是解释型语言。

## 复杂的运行机制

现实中的程序运行其实有更加复杂的机制。

比如CERN的一帮子人开发了[ROOT](https://root.cern/)软件，就实现了解释运行c++。其中的c++解释器[cling](https://root.cern/cling/)可以独立安装，你也可以自己下载着玩。当然[jupyter](https://jupyter.org/)出来以后，各种语言没有一两个解释器都不好意思，这里有[jupyter kernel列表](https://github.com/jupyter/jupyter/wiki/Jupyter-kernels)。

julia运行方式和python看上去差不多，但是背后是基于`llvm`开发的**jit（just in time，即时编译）**技术，以此获得更快的速度。python的`numba`等库，也可以将部分python代码做即时编译，这样的程序运行起来就是一边解释一边编译了。java会将源代码文件编译成字节码，但是这种字节码和机器码是不一样的，还需要在java虚拟机内运行，看上去是既要编译又要解释。

## 环境(environment)

代码的开发和运行都在某个特定的电脑上，换一个电脑可能就会出错。我们将这个电脑的各种设置和资源称为环境。

当我们把一个程序复制到另一台电脑上时，有哪些可能会出错呢？

1. 二进制不兼容。这需要是针对编译成了机器码的`.exe`文件来说的。机器码是依赖于cpu和操作系统的，在不同的cpu核操作系统上并不能通用。一个程序编译成了`.exe`文件，拷贝到另外一个电脑上很有可能会出错。在本地windows电脑上编译好的文件，复制到linux服务器上是不能运行的，必须复制源代码，并在服务器上重新编译才行。此外，不同编译器生成的二进制文件也是不兼容的，`gfortran`和`ifort`编译器生成的二进制文件文件是不能链接到一起的。

2. 操作系统依赖的代码。这条是针对源代码的。当在源代码中使用诸如
   ```c++
   #include <Windows.h>
   ```
   这样的代码。由于`Windows.h`是windows系统独有的头文件，是用来调用一些系统函数的，所以这种代码显然是不能在linux下编译通过的。

3. 编译器或者解释器的版本问题。编程语言并不是一成不变的，python官网可以看到不同版本的python解释器。c++也在不断推出新的版本。如果程序使用了`c++11`版本的写法，但是编译器版本比较老，还不支持这种写法，就会出错。解释器也有类似的问题。

4. 库的缺失。如果程序开发使用了某个库，但是在另外一台电脑上没有装这个库，则会无法编译通过或无法解释运行。

以上这些也是泛泛而谈。对于编译型语言，我认为有必要区分两个步骤下的环境

1. 开发环境(development environment)。可以简单的理解为编译代码时所需要的的环境。比如头文件，库文件，编译器等等。
2. 运行时环境(runtime environment)。即运行代码所需要的环境。按理说，编译型语言编译成机器码之后，就不依赖于源文件和编译器。除了二进制兼容这个基本要求外，生成的`.exe`文件还有可能会依赖于动态链接库。关于动态链接库后面还会详细讲。

> windows下的动态链接库拓展名为`.dll`，linux下的动态链接库拓展名为`.so`。有的时候玩老游戏，比如galgame，可能会提示`xxx.dll`文件缺失，这就是运行时环境的问题，此时只需要去一些`dll`收录网站下载对应的的`.dll`文件就好了。（注意小心病毒）

对于解释型语言，没法区分开发环境和运行时环境，不如说都是运行时环境。解释型语言运行时依赖解释器，程序中使用的各种库等等。

> 除了程序相关的东西是环境，广义的讲还有很多东西也是环境的一部分。比如字体环境：`latex`编译或者`matplotlib`作图有时会出现缺少字体的问题，因为你的电脑上没有安装某种字体。

### 虚拟环境

虚拟环境的技术，即创建一个独立得开发环境，不和电脑的默认环境相关，这样在配置开发环境时不会污染计算机默认环境。另一方面，你也不用受制于默认环境，可以自由的指定虚拟环境。

python有著名的[conda](https://conda.io/en/latest/index.html)虚拟环境管理软件，他也是[anaconda](https://www.anaconda.com/)的一部分。

此外还有容器技术如[docker](https://www.docker.com/)等等。我对这些并不是很熟悉，仅供参考。