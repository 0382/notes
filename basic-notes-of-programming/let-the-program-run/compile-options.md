# 【程序的运行（四）】gcc编译器选项

本节讲讲gcc/g++/gfortran编译器的一些选项。

前面我们讲[编译c语言](../let-the-program-run/compile-c-language.md)，用到了不少编译器的命令行参数。下面介绍一下`gcc/g++/gfortran`编译器的一些比较常用的参数。

## 常用选项

1. `-o filename`

用`-o`指定输出文件，后面跟着输出文件的文件名。（注意这实际上是两个命令行参数，并且必须是紧挨着的）

2. `-E, -S, -c`

这是前面介绍过的，预处理、编译、汇编三个步骤的选项。实际操作中，我们并不需要显式指定这个三个步骤，而是直接使用`-c`选项一次性完成这三个步骤。于是这三个步骤合起来也可以称为编译步骤。

3. `-I path/to/include`

指定头文件目录。有的时候，我们不仅仅在当前文件夹下有头文件，在别的文件夹下有头文件，此时可以用`-I`选项来指定头文件目录。

4. `-g`

编译时加入调试信息。编译时加入源代码信息，这样调试的时候才能够知道运行的每一步对应的是哪一行代码。调试程序时需要使用这个选项。

## 链接库

5. `-L path/to/library`

指定库文件目录。一般来说，linux下有一些系统默认的库目录，这些目录不用指定。但是如果是你自己编译的库，有时就需要指定目录了。

6. `-l{libname}`

指定动态链接库名字。这里的`{libname}`是代指某个库的名字。比如说`gsl`库，其动态链接库的库文件名字是`libgsl.so`，此时用`-lgsl`选项指定这个库。再比如，`openblas`库，其库名字是`libopenblas.so`，此时用`-lopenblas`选项指定库。其他的也都是按照这个规律来。

7. `-static`

使用静态链接库，而不是动态链接库。

8. `-shared`

将自己的代码编译成动态链接库。

## 编译优化

主要是`-O`等选项，关于编译优化具体看[gcc文档](https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html)。我也并不是计算机大佬，只能大概说一说，可能会有错误，仅供参考。

优化等级有`-O0,-O1,-O2,-O3`这几级，其中`-O0`是默认选项，相当于什么都不加。数字越大优化程度越高。除此之外，还有`-Os`保持输出文件最小，`-Og`优化的同时不损失调试信息，`-Ofast`在`-O3`基础上加上`-ffast-math`选项。

所谓优化，就是将c/c++语句编译成机器码的时候，有时候并不是逐句翻译，而是采取一些等效替代的方法，获得更高的性能。

优化选项可以获得性能提升，但是也可能会造成程序错误。**做高性能计算的代码，是必须要开启优化选项**的，否者可能有一些程序你这辈子都跑不完。

看各种博客，普通的软件开发代码一遍使用`-O2`，为了稳定性。对于高性能计算的代码，我其实也没有经验，果不愿意想太多，就开`-O3`优化吧，程序出错了再说。

## c++标准

c++标准最近几年还是比较激进的。我上课教时学的还是c++98的内容。现在c++11应该是通行标准了，不熟悉的同学可以上网找找博客了解一下。

g++指定c++标准使用`-std=c++11, -std=c++14, -std=c++17`等。老的编译器默认是c++98，现在最新的编译器一般都是默认c++11，甚至是c++17了。c++20, c++23标准也已经有了，编译器跟进还要一段时间，但是肯定是会不断更新的，可以在这里看到各大编译器跟进最新标准的进展：[C++ 编译器支持情况表](https://zh.cppreference.com/w/cpp/compiler_support)。计算机是与时俱进的，要不断学习才行。

除了c++标准，c语言和fortran标准也都有发展。c语言标准相关可以参考[c参考手册](https://zh.cppreference.com/w/c)。c语言标准最重要的更新内容大概是C11，新的编译器一般都默认了，老编译不默认支持可以用`-std=c11`指定。

fortran其实在f95之后还有03版，08版，18版等更新。我只是在维护一些fortran程序，暂时没有自己写fortran程序的可能，对这些新标准我并不熟悉。很多老古董程序一般是在f90/f95下写的，甚至还有fortran77的。

f95之后的更新并不是像77->90那样的超级大改，不过新增了很多现代化语法，变化还是有点大的。鉴于最近fortran语言似乎有回光返照的趋势：[如何评价Fortran语言热度的回升？](https://www.zhihu.com/question/466784149/answer/1984007533)而且最近看到一些科学计算程序里面也出现了不少新版的语法，甚至还有[fypp](https://github.com/aradi/fypp)这种邪道语言的出现。而我们的fortran程序员还在看彭国伦的《Fortran95程序设计》。如果什么时候我还有比较多闲的没事干的时间，也许会好好学习一下fortran的新标准。

值得一提的是，之前讲语言混编：[编译多文件项目](../let-the-program-run/compile-multi-file-project.md)，是依靠命名粉碎来做的。虽然像[BLAS](http://www.netlib.org/blas/)库这些老古董还在干这些勾当，其实fortran新标准提供了更加规范的与c语言链接的方式。参考这位知乎大佬的文章：[现代化的Fortran 之 撤离Fortran指南](https://zhuanlan.zhihu.com/p/21470601)。

## 其他

`-pthread`，使用`pthread`库，gcc编译器使用`<thread>`线程库时必须加这个选项，是标准库非常奇怪的一个例外。

`-fopenmp`，使用`openmp`。
