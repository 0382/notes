# 【代码编辑（三）】文字编码

这里讲讲文字编码，也算是计算机基础知识，对于代码编辑用处不大，但是如果你困扰于各种中文乱码，可以看看本文。

### 二进制，字节

首先复习一下字节(Byte)概念。电脑的数据都是二进制形式，一个二进制位叫做比特(bit)，8个二进制位叫做字节(Byte)。一个字节可以表示$2^8=256$个整数。计算机的内存分配都是以字节为单位，而不是按照比特为单位的。所以c++中的`bool`类型，虽然代数上只占一个比特，但是在计算机表示中还是要占一个字节。

### ASCII

计算机是英语世界发明的，自然首先需要解决英语的编码问题。英语的编码很简单，就是c/c++课上老师让大家背的ASCII码表。比如用`97`表示字符`'a'`，那么在计算机读取到磁盘上某个字节等于`97`时，就知道这里是一个`'a'`字符了。

ASCII字符占用一个字节，理论上可以表示0-256，虽然实际上只定义了`0-128`这128个字符。

### GBK, ANSI

一个字节最多表示256个字符，中文显然不止这么多。所以表示中文至少要两个字节。[国标2312](http://std.samr.gov.cn/gb/search/gbDetailed?id=71F772D79E19D3A7E05397BE0A0AB82A)(GB2312)是中国第一版的汉字编码国家标准，此后还有[GBK](https://baike.baidu.com/item/GBK%E5%AD%97%E5%BA%93/3910360)和[GB18030](http://std.samr.gov.cn/gb/search/gbDetailed?id=71F772D800B5D3A7E05397BE0A0AB82A)等国家标准。他们都是变长编码，其中单字节和ASCII一致，而中文都采取双字节编码。直到GB18030，两字节都不够用了，所以也有部分的汉字是采取四字节编码。

ANSI是Windows的默认编码。其实这并不能算是一种编码，而是跟随系统本地化设置的变动的一种编码。在中国，ANSI意味默认编码是GBK，在港澳台地区默认编码是繁体字编码Big-5，在日本韩国等地也是跟随他们当地的标准使用的编码。

如果你在中国使用Windows，大约记住默认编码是GBK就好了。而GBK汉字都是两个字节。老编程工具一般都是跟随系统，所以都是采用GBK编码，其中每个中文字符占用两个字节。

### Unicode

Unicode是[统一码联盟](https://home.unicode.org/)这个国际组织制定的字符集，意在统一所有的编码。因为不同地区制定的编码，通常会有冲突，在不同国家的标准中，可能同一个数字表示的是不同的字符。Unicode规定了某个字符到一个自然数的映射，理论上讲没有上限。

现在的Unicode字符数在四字节可以表示的数以内，即少于$2^{32} = 4294967296$个字符。但是计算机如何表示这样的一系列自然数，是可以采用不同的方案的。

#### UTF32

既然现在的Unicode字符数小于$2^{32}$个，使用四个字节表示不会溢出，那就直接用四个字节表示字符。linux下`wchar_t`类型对应的就是这种编码。

UTF32的问题在于，我们通常使用的大部分字符对应的自然数其实都不大，如果每个字符都强行用四个字节就会非常浪费空间。于是就有了变长编码方案。

#### UTF8

变长编码。单字节部分和ASCII兼容，之后有两字节部分，三字节部分和四字节部分（UTF8编码方案理论上还预留了5字节和6字节，目前还没用上）。其中汉字主要是三字节，有部分是四字节。这是linux下`char`的对应的编码。

如果对于UTF8编码原理感兴趣，可以阅读这位知乎大佬的文章：[UTF-8 编解码算法赏析](https://zhuanlan.zhihu.com/p/72254734)。

#### UTF16

变长编码。最小是两字节（包括英文字母也是）。中文主要是两字节，部分是四字节。这是Windows下的`wchar_t`的默认编码。

UTF32显然不能广泛使用。现在使用最为广泛的还是UTF8，因为比起UTF16至少是两字节，UTF8的ASCII字符是单字节的。现在网页源代码中有大量的ASCII字符，使用UTF8可以大大减少网络传输数据量。虽然UTF8中文占三个字符对于中文用户来说不太友好，但还是建议统一使用UTF8编码。

#### UCS

UCS是[国际标准组织](https://www.iso.org/home.html)指定的字符集。后面两家为了真正统一编码，两边的标准实际上一致的。其中UCS4和UTF32是一致的，而UCS2相当于UTF16中双字节的部分。

### 软件和操作系统编码现状

微软冠冕堂皇的在官网文档声称自己有Unicode支持，实际上就是个UTF16而已。`<Windows.h>`中定义的系统函数，很多既有`char`版本的，对应编码是ANSI；又有`wchar_t`版本的，对应编码是UTF16。当然如果不是做Windows系统开发，我想我们很少会碰`<Windows.h>`头文件。

Windows下的软件，分成两类，一类是跟着系统走，那么默认是ANSI，比如`vc++ 6.0`, `code::blocks`；一类是跟主流走，使用UTF8，比如`vscode`。默认使用UTF16的软件相对较少，但也不是没有，比如`powershell`就是UTF16的。

unix/linux采取了UTF8作为默认编码。一般的软件也都默认采用UTF8编码。苹果系统也是这样的。所以在这些系统里面，比较简单，所有的都是UTF8。

c/c++/fortran是跟随系统的代表，在windows下默认编码是ANSI，在linux下默认是UTF8。比较新的语言，比如python，julia，rust等语言都统一采用UTF8。

### 实践建议

- 如果你的文件打开乱码了，一般来说是遇到了编码问题，通常的代码编辑器都可以选择编码，可以换个编码打开文件试试。
- 使用编辑器新建文件，最好总是设置成默认编码为UTF8。
- 可以使用中文做注释，但是在c/c++/fortran中尽量不要在代码中操作中文，除非你清醒的知道，`string s = "你好世界"`这个字符串，在你当前的编辑器下，以及可能会用到它的软件里面，分别占用几个字节。